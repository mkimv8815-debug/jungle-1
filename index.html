<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>都市迷雾·觉醒之路</title>
  <style>
    /* ========== 暗黑星光 UI ========== */
    :root {
      --bg: #0f0f15;
      --card: #1a1a22;
      --text: #e6e6ff;
      --accent: #bb86fc; /* 紫色霓虹 */
      --lion: #ff7eb9;   /* 粉红 */
      --fox: #ff9e6d;    /* 橙 */
      --cat: #64b5f6;    /* 蓝 */
      --deer: #81c784;   /* 绿 */
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", sans-serif;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* 星空背景 */
    .stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    .star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      animation: twinkle var(--duration) infinite ease-in-out;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.9; }
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .screen {
      display: none;
      padding: 30px 20px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: fadeIn 0.5s ease;
      position: relative;
      z-index: 10;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .active { display: block; }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: var(--accent);
      text-align: center;
    }
    h2 {
      font-size: 22px;
      margin: 20px 0 15px;
      color: var(--text);
    }
    p {
      margin: 12px 0;
      font-size: 16px;
    }
    .chapter-desc {
      font-style: italic;
      color: #aaa;
      margin: 15px 0 25px;
      padding-left: 10px;
      border-left: 2px solid var(--accent);
    }
    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 12px 24px;
      margin: 10px 5px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }
    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .option {
      background: rgba(255,255,252,0.05);
      border: 1px solid #333;
      padding: 14px;
      margin: 10px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      background: rgba(255,255,252,0.1);
      border-color: var(--accent);
    }
    .selected {
      background: rgba(187, 134, 252, 0.15);
      border-color: var(--accent);
    }
    .multi-warning {
      color: #ff9e6d;
      font-size: 14px;
      margin-top: 8px;
    }
    .result-card {
      text-align: center;
      padding: 30px;
      background: rgba(26, 26, 34, 0.7);
      border-radius: 16px;
      margin: 20px 0;
    }
    .result-title {
      font-size: 28px;
      margin: 15px 0;
      color: white;
    }
    .result-desc {
      font-size: 16px;
      color: #ccc;
      margin: 20px 0;
      line-height: 1.7;
    }
    .result-insight {
      color: #aaa;
      font-size: 15px;
      margin-top: 15px;
      line-height: 1.6;
    }
    .save-hint {
      background: rgba(187, 134, 252, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 25px 0;
      font-size: 15px;
      color: var(--accent);
    }
    footer {
      text-align: center;
      margin-top: 40px;
      color: #666;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      .screen { padding: 20px 15px; }
      h1 { font-size: 24px; }
      .btn { width: 100%; margin: 8px 0; }
    }
  </style>
</head>
<body>
  <!-- 星空背景容器 -->
  <div class="stars-container" id="stars"></div>

  <div class="container">
    <!-- 封面 -->
    <div id="screen-cover" class="screen active">
      <h1>都市迷雾·觉醒之路</h1>
      <p style="text-align:center; margin:20px 0;">
        欢迎来到都市丛林。<br>
        在这里，没有绝对的善恶，只有生存的本能。
      </p>
      <p style="text-align:center; color:#aaa; font-style:italic;">
        请跟随第一直觉作答。
      </p>
      <div style="text-align:center; margin-top:30px;">
        <button class="btn" onclick="showScreen('q1')">踏入丛林</button>
      </div>
    </div>

    <!-- Q1 -->
    <div id="q1" class="screen">
      <h2>Chapter 1 【初入丛林 · 伪装与破局】</h2>
      <p class="chapter-desc">你收到了一张神秘的邀请函，来到一座摩天大楼的顶层酒会。大门打开，声浪袭来，那是你从未见过的繁华名利场。</p>
      <h2>Q1. 【入场】侍者端着托盘经过，你取过一杯香槟。此时，大厅中央似乎有一位重要人物正在高谈阔论。你的本能反应是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q1', 'A')">A. 径直走过去，我要听听他在说什么，顺便找机会让他注意到我。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q1', 'B')">B. 兴奋地钻进人群，这里的每个人看起来都很厉害，我要多认识几个！</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q1', 'C')">C. 找个安静的露台，靠着栏杆抿一口酒，冷眼观察这个浮夸的名利场。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q1', 'D')">D. 在餐台旁找个位置，先吃点东西垫垫肚子，这让我感到安全。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q1', 'q2')" id="btn-q1" disabled>继续</button>
      </div>
    </div>

    <!-- Q2 -->
    <div id="q2" class="screen">
      <h2>Q2. 【破冰】突然，一个陌生人微笑着向你走来，似乎想和你攀谈。你的第一句开场白策略是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q2', 'A')">A. 单刀直入："你好，我是做[行业]的，你是？"（快速筛选价值）</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q2', 'B')">B. 热情赞美："哇你的胸针好特别！很有品味耶！"（快速拉近关系）</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q2', 'C')">C. 礼貌等待：微微点头致意，等对方先开口，绝不主动暴露底牌。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q2', 'D')">D. 温和回应："你好，我是[名字]，很高兴认识你。"（安全不出错）</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q2', 'q3')" id="btn-q2" disabled>继续</button>
      </div>
    </div>

    <!-- Q3 (多选) -->
    <div id="q3" class="screen">
      <h2>Q3. 【装备】（至多选2项）</h2>
      <p style="color:#aaa; margin:10px 0;">每件装备代表一种生存策略，请根据直觉选择你此刻最想拥有的"外挂"。</p>
      <div class="option multi" data-choice="A" onclick="toggleMulti(this, 'q3', 'A')">A. 权杖（让所有人都无条件服从我的指令）</div>
      <div class="option multi" data-choice="B" onclick="toggleMulti(this, 'q3', 'B')">B. 千面面具（能瞬间变成对方喜欢的性格）</div>
      <div class="option multi" data-choice="C" onclick="toggleMulti(this, 'q3', 'C')">C. 隐身斗篷（想消失时谁也找不到我）</div>
      <div class="option multi" data-choice="D" onclick="toggleMulti(this, 'q3', 'D')">D. 治愈药水（能化解尴尬，带来和平）</div>
      <div class="option multi" data-choice="E" onclick="toggleMulti(this, 'q3', 'E')">E. 真视之眼（一眼看穿谎言与虚伪）</div>
      <div class="option multi" data-choice="F" onclick="toggleMulti(this, 'q3', 'F')">F. 扩音喇叭（让我的声音传遍全场）</div>
      <p class="multi-warning" id="multiWarn3"></p>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q3', 'q4')" id="btn-q3" disabled>继续</button>
      </div>
    </div>

    <!-- Q4 -->
    <div id="q4" class="screen">
      <h2>Chapter 2 【丛林法则 · 竞争与冲突】</h2>
      <p class="chapter-desc">酒会结束，你加入了一个精英探险队。资源开始紧缺，风暴即将来临，人性的阴暗面开始显露。</p>
      <h2>Q4. 【分歧】探险队在一个分叉路口迷路了，队长拿不定主意，队员们开始争吵。此时你会？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q4', 'A')">A. 大声喝止："别吵了！听我的！走左边，出了事我负责！"</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q4', 'B')">B. 做和事佬："哎呀大家别伤和气，要不我们抛硬币决定？"</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q4', 'C')">C. 冷眼旁观：看着他们吵，心想这群乌合之众真没效率。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q4', 'D')">D. 默默跟随：心里很慌，但不敢说话，谁声音大我就跟谁走。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q4', 'q5')" id="btn-q4" disabled>继续</button>
      </div>
    </div>

    <!-- Q5 -->
    <div id="q5" class="screen">
      <h2>Q5. 【背刺】当你正在努力开路时，你发现队友在背后偷偷把你辛苦收集的果实分给了别人，还说了你坏话。你会？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q5', 'A')">A. 当场爆发：直接杀回去对质，把事情闹大，绝不吃哑巴亏。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q5', 'B')">B. 笑着反击：表面开玩笑，实则阴阳怪气地刺回去，让他下不来台。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q5', 'C')">C. 记仇拉黑：一言不发，但在心里给他判了死刑，寻找机会一击必杀。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q5', 'D')">D. 自我怀疑：躲起来难过，反思是不是自己哪里做得不够好。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q5', 'q6')" id="btn-q5" disabled>继续</button>
      </div>
    </div>

    <!-- Q6 (多选) -->
    <div id="q6" class="screen">
      <h2>Q6. 【技能】（至多选2项）</h2>
      <p style="color:#aaa; margin:10px 0;">为了应对接下来的危机，你决定觉醒一种"战斗本能"，你会选？</p>
      <div class="option multi" data-choice="A" onclick="toggleMulti(this, 'q6', 'A')">A. 震慑咆哮（让敌人恐惧而不敢靠近）</div>
      <div class="option multi" data-choice="B" onclick="toggleMulti(this, 'q6', 'B')">B. 魅惑之术（化敌为友，让敌人不忍下手）</div>
      <div class="option multi" data-choice="C" onclick="toggleMulti(this, 'q6', 'C')">C. 弱点洞察（找出逻辑漏洞，一击致命）</div>
      <div class="option multi" data-choice="D" onclick="toggleMulti(this, 'q6', 'D')">D. 绝对坚盾（内心不崩，用沉默构筑隔离墙）</div>
      <div class="option multi" data-choice="E" onclick="toggleMulti(this, 'q6', 'E')">E. 疾跑闪避（打不过就跑，保命要紧）</div>
      <div class="option multi" data-choice="F" onclick="toggleMulti(this, 'q6', 'F')">F. 召唤盟友（呼唤一群帮手来一起打）</div>
      <p class="multi-warning" id="multiWarn6"></p>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q6', 'q7')" id="btn-q6" disabled>继续</button>
      </div>
    </div>

    <!-- Q7 -->
    <div id="q7" class="screen">
      <h2>Chapter 3 【迷雾深处 · 自我与代价】</h2>
      <p class="chapter-desc">你活了下来，并且拥有了一席之地。但夜深人静时，你看着水中的倒影，开始审视真正的代价。</p>
      <h2>Q7. 【独处】终于结束了一天漫长的狩猎，回到巢穴，你最想做的事情是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q7', 'A')">A. 复盘：思考今天的得失，规划明天的版图，野心让我无法休息。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q7', 'B')">B. 组局：太安静了受不了，约几个朋友喝酒、连麦、打游戏。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q7', 'C')">C. 封闭：关上门窗，看书、独处，谁也别来烦我。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q7', 'D')">D. 疗愈：泡个澡，撸撸猫，刷刷治愈视频，让自己放松下来。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q7', 'q8')" id="btn-q7" disabled>继续</button>
      </div>
    </div>

    <!-- Q8 -->
    <div id="q8" class="screen">
      <h2>Q8. 【代价】有人告诉你，想要爬到丛林的最顶端，必须献祭掉一样东西，你愿意牺牲什么？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q8', 'A')">A. 被人喜欢：无所谓，强者注定是孤独和被误解的。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q8', 'B')">B. 部分真实：为了合群和受欢迎，我可以戴上面具演戏。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q8', 'C')">C. 部分人际：如果他们跟不上我的步伐，我不介意分道扬镳。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q8', 'D')">D. 我不愿牺牲：如果代价这么大，我宁愿做一个快乐的普通人。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q8', 'q9')" id="btn-q8" disabled>继续</button>
      </div>
    </div>

    <!-- Q9 -->
    <div id="q9" class="screen">
      <h2>Q9. 【金钱】你在丛林深处发现了一个宝箱，你希望里面装的是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q9', 'A')">A. 权杖与印章：代表无上的权力和对资源的支配权。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q9', 'B')">B. 粉丝契约：代表无数人的追随和崇拜。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q9', 'C')">C. 真理之书：记载着世界的底层逻辑，让我看透一切。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q9', 'D')">D. 无尽粮仓：足够我和家人吃一辈子，永远不用再冒险。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q9', 'q10')" id="btn-q9" disabled>继续</button>
      </div>
    </div>

    <!-- Q10 -->
    <div id="q10" class="screen">
      <h2>Chapter 4 【终局 · 物种觉醒】</h2>
      <p class="chapter-desc">迷雾散去，你的身体发生了变化。你终于看清了自己在这个丛林里的真实形态。</p>
      <h2>Q10. 如果用一种天气来形容你现在的内心状态，那是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q10', 'A')">A. 烈日：炽热、直接、但也容易灼伤人。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q10', 'B')">B. 彩虹：绚丽、多变、讨人喜欢但稍纵即逝。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q10', 'C')">C. 极夜：深邃、冷静、虽然寒冷但有星光。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q10', 'D')">D. 微风：温柔、无害、让人感到舒适。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q10', 'q11')" id="btn-q10" disabled>继续</button>
      </div>
    </div>

    <!-- Q11 -->
    <div id="q11" class="screen">
      <h2>Q11. 在这个丛林里，你最不能容忍的"同伴"是？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q11', 'A')">A. 软弱者：遇事只会哭，没有任何解决问题的能力。</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q11', 'B')">B. 无趣者：一本正经，开不起玩笑，像块木头。</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q11', 'C')">C. 愚蠢者：逻辑混乱，情绪化，无法沟通。</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q11', 'D')">D. 冷酷者：为了利益不择手段，没有人情味。</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="nextQuestion('q11', 'q12')" id="btn-q11" disabled>继续</button>
      </div>
    </div>

    <!-- Q12 -->
    <div id="q12" class="screen">
      <h2>Q12. 【终章】当你老去，即将离开这个丛林时，你希望墓碑上刻着什么评价？</h2>
      <div class="option" data-choice="A" onclick="selectSingle(this, 'q12', 'A')">A. "他是个传奇……但他这一生没几个真正的朋友。"</div>
      <div class="option" data-choice="B" onclick="selectSingle(this, 'q12', 'B')">B. "大家都爱他……但没人知道他真实的样子。"</div>
      <div class="option" data-choice="C" onclick="selectSingle(this, 'q12', 'C')">C. "他看透了一切……但也因此活得太清醒太累。"</div>
      <div class="option" data-choice="D" onclick="selectSingle(this, 'q12', 'D')">D. "他是个好人……可惜他这辈子过得太普通了。"</div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="calculateResult()">完成测试</button>
      </div>
    </div>

    <!-- 结果页 -->
    <div id="result-screen" class="screen">
      <h1>觉醒完成</h1>
      <div class="result-card">
        <h2 class="result-title" id="result-title">-</h2>
        <p class="result-desc" id="result-desc">-</p>
        <p class="result-insight" id="result-insight" style="color:#aaa; font-size:15px; margin-top:15px; line-height:1.6;"></p>
      </div>
      <div class="save-hint">
        <strong>💡 提示：</strong>详情请查看《都市丛林 · 生存深度诊断书》
      </div>
      <footer>
        <p>© 观心舟</p>
      </footer>
    </div>
  </div>

  <script>
    // ===== 初始化星空背景 =====
    function createStars() {
      const container = document.getElementById('stars');
      const starCount = window.innerWidth > 600 ? 120 : 60;
      
      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        
        // 随机位置
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        star.style.left = `${x}%`;
        star.style.top = `${y}%`;
        
        // 随机大小 (0.5px ～ 2px)
        const size = 0.5 + Math.random() * 1.5;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        
        // 随机动画时长 (2s ～ 6s)
        const duration = 2 + Math.random() * 4;
        star.style.setProperty('--duration', `${duration}s`);
        
        // 随机延迟
        star.style.animationDelay = `${Math.random() * 5}s`;
        
        container.appendChild(star);
      }
    }

    // 页面加载完成后创建星空
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', createStars);
    } else {
      createStars();
    }

    // ===== 数据结构 =====
    let scores = { L: 0, F: 0, C: 0, D: 0 };
    let singleAnswers = {};
    let multiChoices = { q3: [], q6: [] };

    // 【关键修改】统一名称：使用诊断书中正式命名
    const questionMap = {
      'L': ['🦁', '荒原狮王'],
      'F': ['🦊', '千面灵狐'],
      'C': ['🐈', '屋顶黑猫'],
      'D': ['🦌', '迷雾森鹿']
    };

    // 【关键修改】组合名称严格对齐诊断书第五章
    const comboNames = {
      'LF': '【帝国缔造者】',
      'LD': '【铁血守护者】',
      'FC': '【假面观察员】',
      'CL': '【冷血战略家】'
      // 其他组合保留通用描述，因诊断书仅详述此4种复合形态
    };

    // 【关键修改】组合描述完全引用诊断书原文
    const comboDescriptions = {
      'LF': '这是最完美的政客模型，也是成功率最高的配置。你拥有狮子的战略宏图，又修练出了狐狸的手腕身段。你知道什么时候该用雷霆手段杀伐决断，也知道什么时候该推杯换盏拉拢人心。你既是暴君，又是明星。',
      'LD': '极具反差魅力的领袖。外表是替大家挡风遮雨的霸气大哥/大姐，内心其实极其柔软细腻。“心有猛虎，细嗅蔷薇”说的就是你。跟随你的人会有极强的安全感，因为他们知道你会为了护犊子对抗全世界。',
      'FC': '当代的“人间清醒”。你在酒局上谈笑风生（狐狸面具），内心却在冷冷地给每个人打分、建模（黑猫底色）。你入世，但不出世。你配合所有人演戏，但绝不入戏。你利用规则，但鄙视规则。',
      'CL': '幕后的操盘手。你本质喜欢独处，但为了达成目标，你逼迫自己站到台前。你的领导风格是精密计算的，不带感情色彩。你不打无准备之仗，你的每一个决策都经过了风险评估。你是一台没有感情的胜利机器。'
    };

    // ===== 事件处理 =====
    function selectSingle(element, questionId, choice) {
      try {
        // 清除同题其他选项
        const options = document.querySelectorAll(`#${questionId} .option:not(.multi)`);
        options.forEach(opt => {
          if (opt && opt.classList) {
            opt.classList.remove('selected');
          }
        });
        
        if (element && element.classList) {
          element.classList.add('selected');
        }
        
        // 映射 A->L, B->F, C->C, D->D
        const mappedChoice = mapChoiceToType(choice);
        if (mappedChoice in scores) {
          scores[mappedChoice]++;
        }
        singleAnswers[questionId] = mappedChoice;
        
        const button = document.getElementById(`btn-${questionId}`);
        if (button) {
          button.disabled = false;
        }
      } catch(e) {
        console.error("Error in selectSingle:", e);
      }
    }

    function toggleMulti(element, questionId, choice) {
      try {
        let currentList = multiChoices[questionId] || [];
        
        if (currentList.includes(choice)) {
          multiChoices[questionId] = currentList.filter(c => c !== choice);
          if (element && element.classList) {
            element.classList.remove('selected');
          }
        } else if (currentList.length < 2) {
          multiChoices[questionId] = [...currentList, choice];
          if (element && element.classList) {
            element.classList.add('selected');
          }
        }
        
        updateMultiWarning(questionId);
        const button = document.getElementById(`btn-${questionId}`);
        if (button) {
          button.disabled = (multiChoices[questionId].length === 0);
        }
      } catch(e) {
        console.error("Error in toggleMulti:", e);
      }
    }

    function updateMultiWarning(questionId) {
      try {
        const warnEl = document.getElementById(`multiWarn${questionId.replace('q', '')}`);
        if (warnEl) {
          const currentList = multiChoices[questionId] || [];
          warnEl.textContent = currentList.length >= 2 ? '已选2项，无法再选' : '';
        }
      } catch(e) {
        console.error("Error in updateMultiWarning:", e);
      }
    }

    function showScreen(screenId) {
      try {
        document.querySelectorAll('.screen').forEach(el => {
          if (el && el.classList) {
            el.classList.remove('active');
          }
        });
        const targetScreen = document.getElementById(screenId);
        if (targetScreen && targetScreen.classList) {
          targetScreen.classList.add('active');
        }
      } catch(e) {
        console.error("Error in showScreen:", e);
      }
    }

    function nextQuestion(current, next) {
      showScreen(next);
    }

    // ===== 核心算法：严格按照 v2.0 规则 =====
    function calculateResult() {
      try {
        // Step 1: 处理多选题加分
        processMultiChoices();

        // Step 2: 判定底色人格（Base Persona）
        const basePersona = determineBasePersona();

        // Step 3: 判定面具人格（Mask Persona）
        const maskPersona = determineMaskPersona(basePersona);

        const titleEl = document.getElementById('result-title');
        const descEl = document.getElementById('result-desc');
        const insightEl = document.getElementById('result-insight');

        // 纯血人格的小知识模板（严格对齐诊断书第五章）
        const pureInsights = {
          'L': '纯血狮：孤独的暴君。除了一路向上，你别无选择。你的宿命就是征服，或者死在征服的路上。',
          'F': '纯血狐：千面戏子。人生如戏，对你来说没有真假，只有“好戏”和“烂戏”。你可能已经忘了自己长什么样。',
          'C': '纯血猫：疯批天才。你是离神最近、也离精神病院最近的人。如果你能找到一个能读懂你代码的人，你会改变世界；否则，你会溺死在自己的精神世界里。',
          'D': '纯血鹿：受难圣徒。你的善良是一种信仰。在这个疯狂的世界里，你是最后一道防线。你以自我牺牲来救赎他人。'
        };

        // 组合人格的小知识模板（按 CF 格式统一生成）
        const comboInsight = 
          `底色是 ${basePersona}（${questionMap[basePersona][1]}）\n` +
          `面具是 ${maskPersona}（${questionMap[maskPersona][1]}）`;

        if (scores[basePersona] >= 9) {
          // 纯血结果（诊断书要求 >75%，共12题，9/12=75%）
          const fullTitle = `【纯血·${questionMap[basePersona][1]}】`;
          titleEl.textContent = `${questionMap[basePersona][1]}（${basePersona}）`;
          descEl.textContent = getPureBloodDescription(basePersona);
          insightEl.textContent = pureInsights[basePersona];
        } else {
          // 组合结果
          const comboKey = basePersona + maskPersona;
          const comboName = comboNames[comboKey] || `${questionMap[basePersona][1]}+${questionMap[maskPersona][1]}`;
          
          // 标题格式：【帝国缔造者】（LF）
          titleEl.textContent = `${comboName}（${comboKey}）`;
          
          // 描述优先使用诊断书定义，否则回退
          descEl.textContent = comboDescriptions[comboKey] || 
            `${questionMap[basePersona][1]}与${questionMap[maskPersona][1]}的融合体，复杂而多面。`;
          
          insightEl.textContent = comboInsight;
        }

        showScreen('result-screen');
      } catch(e) {
        console.error("Error in calculateResult:", e);
        document.getElementById('result-title').textContent = "计算出错";
        document.getElementById('result-desc').textContent = "请刷新页面重试";
        document.getElementById('result-insight').textContent = "";
        showScreen('result-screen');
      }
    }

    // 辅助函数
    function mapChoiceToType(choice) {
      const mapping = { 'A': 'L', 'B': 'F', 'C': 'C', 'D': 'D' };
      return mapping[choice] || choice;
    }

    function processMultiChoices() {
      try {
        // Q3 处理
        (multiChoices.q3 || []).forEach(choice => {
          if (['A','B','C','D'].includes(choice)) {
            const mapped = mapChoiceToType(choice);
            if (mapped in scores) {
              scores[mapped]++;
            }
          } else if (choice === 'E') { // 真视/闪避 → C+1, L+1
            scores.C++; scores.L++;
          } else if (choice === 'F') { // 扩音/召唤 → F+1, L+1
            scores.F++; scores.L++;
          }
        });

        // Q6 处理（同上）
        (multiChoices.q6 || []).forEach(choice => {
          if (['A','B','C','D'].includes(choice)) {
            const mapped = mapChoiceToType(choice);
            if (mapped in scores) {
              scores[mapped]++;
            }
          } else if (choice === 'E') {
            scores.C++; scores.L++;
          } else if (choice === 'F') {
            scores.F++; scores.L++;
          }
        });
      } catch(e) {
        console.error("Error in processMultiChoices:", e);
      }
    }

    function determineBasePersona() {
      try {
        const entries = Object.entries(scores);
        const maxScore = Math.max(...entries.map(([_, s]) => s));
        const topTypes = entries.filter(([_, s]) => s === maxScore).map(([t]) => t);

        if (topTypes.length === 1) {
          return topTypes[0];
        }

        // 平局：用 Q12 一票否决
        if (singleAnswers.q12) {
          return singleAnswers.q12;
        }
        
        // 安全兜底（理论上不会触发）
        return topTypes[0];
      } catch(e) {
        console.error("Error in determineBasePersona:", e);
        return 'L'; // 兜底返回
      }
    }

    function determineMaskPersona(base) {
      try {
        // 规则 A：多选题强制优先
        const allMultiChoices = [...(multiChoices.q3 || []), ...(multiChoices.q6 || [])];
        const nonBaseChoices = allMultiChoices
          .map(c => mapChoiceToType(c))
          .filter(type => type !== base);

        // 统计非底色人格出现次数
        const count = {};
        nonBaseChoices.forEach(type => {
          if (type !== base) { // 确保不包含底色
            count[type] = (count[type] || 0) + 1;
          }
        });

        // 查找出现 >=2 次的类型
        for (const [type, freq] of Object.entries(count)) {
          if (freq >= 2) {
            return type;
          }
        }

        // 规则 B：取总分第二高
        const sorted = Object.entries(scores)
          .filter(([type]) => type !== base)
          .sort((a, b) => b[1] - a[1]);

        if (sorted.length === 0) return base;

        const secondMaxScore = sorted[0][1];
        const secondTypes = sorted.filter(([_, s]) => s === secondMaxScore).map(([t]) => t);

        if (secondTypes.length === 1) {
          return secondTypes[0];
        }

        // 第二名平局：优先看 Q3，再看 Q1
        for (const type of secondTypes) {
          if (multiChoices.q3 && multiChoices.q3.some(c => mapChoiceToType(c) === type)) {
            return type;
          }
        }

        // 如果 Q3 没涉及，用 Q1
        if (singleAnswers.q1 && secondTypes.includes(singleAnswers.q1)) {
          return singleAnswers.q1;
        }

        return secondTypes[0]; // 最终兜底
      } catch(e) {
        console.error("Error in determineMaskPersona:", e);
        return 'F'; // 兜底返回
      }
    }

    function getPureBloodDescription(type) {
      // 【关键修改】纯血描述完全对齐诊断书第五章
      const descriptions = {
        'L': '孤独的暴君。除了一路向上，你别无选择。你的宿命就是征服，或者死在征服的路上。',
        'F': '千面戏子。人生如戏，对你来说没有真假，只有“好戏”和“烂戏”。你可能已经忘了自己长什么样。',
        'C': '疯批天才。你是离神最近、也离精神病院最近的人。如果你能找到一个能读懂你代码的人，你会改变世界；否则，你会溺死在自己的精神世界里。',
        'D': '受难圣徒。你的善良是一种信仰。在这个疯狂的世界里，你是最后一道防线。你以自我牺牲来救赎他人。'
      };
      return descriptions[type] || '你是一个独特而复杂的个体，难以用单一标签定义。';
    }
  </script>
</body>
</html>
